<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head><title>Seasar - DI Container with AOP - </title><meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
<meta http-equiv="Content-Style-Type" content="text/css">
<link href="../seasar_b.css" type="text/css" rel="stylesheet" media="screen"><script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head>
<BODY onload="preload('en')">
<TABLE cellSpacing=0 cellPadding=0 width="100%" align=left border=0>
  <TBODY>
  <TR>
    <TD vAlign=top align=left width=780>
      <TABLE class=white cellSpacing=0 cellPadding=0 width=780 border=0>
        <TBODY>
        <TR>
          <TD colSpan=7><IMG height=5 alt="" src="../images/top01_b.gif" 
            width=780></TD></TR>
        <TR>
          <TD width=235><IMG height=117 alt=Seasar 
            src="../images/top02_b.gif" width=235></TD>
          <TD colSpan=3><IMG height=117 alt="DI Container with AOP" 
            src="../images/top03.gif" width=289></TD>
          <TD colSpan=3><IMG height=117 alt="" 
            src="../images/spacer.gif" width=256></TD></TR>
<tr><td rowspan="2"><img src="../images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/en/index.html"><img src="../images/menu01_b_en.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/en/projects.html"><img src="../images/menu02_b_en.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/en/products.html"><img src="../images/menu06_b_en.gif" height="30" width="110" border="0" alt="" id="menu06" onmouseover="swap(6)" onmouseout="restore(6)"></a></td>
<td><a href="http://www.seasar.org/en/resources.html"><img src="../images/menu05_b_en.gif" height="30" width="113" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></a></td>
<td><img src="../images/menu07_b_en.gif" height="30" width="109" border="0" alt=""  id="menu07" onmouseover="swap(7)" onmouseout="restore(7)"></td>
<td><img height="30" width="34" src="../images/menu06.gif" alt=""></td></tr><tr>
        <TR>
          <TD colSpan=6><IMG height=19 alt="" src="../images/spacer.gif" 
            width=545></TD></TR></TBODY></TABLE>
      <TABLE class=white cellSpacing=0 cellPadding=0 width=780 border=0>
        <TBODY>
        <TR vAlign=top align=left>
          <TD width=18><IMG height=14 alt="" src="../images/spacer.gif" 
            width=18></TD>
          <TD class=main width=744><!-- don't edit end --><!-- document start -->
            <UL>
              <LI><A href="#diconInclude">Setting include path to a dicon file</A> 
              <LI><A href="#uuset">__set() Setter Injection</A> 

              <LI><A href="#ini-dicon">PHP Configuration File Format dicon File</A> 
              <UL>
                <LI><A href="#ini-components">components Section</A> 
                <LI><A  href="#ini-component">component Section</A> 
                <UL>
                  <LI type=circle><A 
                  href="#ini-arg">arg Settings</A> 
                  <LI type=circle><A href="#ini-property">property Settings</A> 
                  <LI type=circle><A href="#ini-init_method">init_method Settings</A> 
                  <LI type=circle><A href="#ini-destroy_method">destroy_method Settings</A> 
                  <LI type=circle><A href="#ini-aspect">aspect Settings</A> 
                  <LI type=circle><A href="#ini-meta">meta Settings</A> 
                  <LI type=circle><A href="#ini-etc">Miscellaneous</A> 
                  </LI></UL></LI></UL>
              <LI><A href="#dba">Database Connection</A> 
              <UL>
                <LI><A href="#dba-ds">Concerning DataSource</A> 
                <UL>
                  <LI type=circle><A href="#dba-ds-peardb">peardb.dicon Template</A> 
                  <LI type=circle><A href="#dba-ds-use">How to use</A> 
                  </LI></UL>
                <LI><A href="#dba-tx">Using TxIntereceptor</A> 
                <LI><A href="#dba-dao">Using SimpleDaoInterceptor</A> 
                <I>(This function has been moved to <A href="http://www.seasar.org/en/php5/s2dao.html">S2Dao.PHP5</A>)</I> 
                <UL>
                  <LI type=circle><A href="#dba-dao-array">Returning an Array</A>
                  <LI type=circle><A href="#dba-dao-bean">Returning an Object</A> 
                  </LI></UL></LI></UL>
              <LI><A href="#unit">S2Unit</A> 
              <UL>
                <LI><A href="#unit-example">Examples</A> 
                </LI></UL></LI></UL><BR><B>
            <H2>Extension</H2></B><A name=diconInclude>
            <H3>Setting include path to a dicon file</H3></A>
            <P>diconファイルのincludeタグのpath属性では、先頭に%...%で囲むことで定数を埋め込むことができます。<BR></P><PRE>define(DICON_DIR,'/path/to/dir');   //定義済みとする

&lt;components&gt;
    &lt;include path="%DICON_DIR%/bar.dicon"/&gt;
&lt;/components&gt;
注) パスの先頭の%...%のみ展開されます。
</PRE><BR><A name=uuset>
            <H3>__set()でのセッター・インジェクション</H3></A>
            <P>PHP5から追加された__set()を使用して、セッター・インジェクションを行うことができます。</P>
            <UL>
              <LI>プロパティが明示的に指定されている (diconファイルで propertyタグが記述されている) 
              <LI>インジェクション対象クラスがセッターメソッドを実装していない 
              <LI>インジェクション対象クラスが__set()を実装している 
            </LI></UL>上記条件に一致する場合に、__set()によりセッター・インジェクションが実行されます。<BR><BR><B>実装クラスの作成</B> 

            <UL>
              <LI type=circle>セッター・メソッド(setMessageA)を定義します。 
              <LI type=circle>__set()を実装します。 
              <LI type=circle>showMessage()を実装します。 </LI></UL>
            <P>$messageBプロパティのセッターメソッドは定義していません。</P><PRE>&lt;?php
class HelloImpl {

    private $messageA = "";
    private $messageB = "";

    function HelloImpl() {}
    
    function setMessageA($messageA){
        $this-&gt;messageA = $messageA;	
    }

    function __set($name,$val){
        $this-&gt;$name = $val;	
    }
    
    function showMessage(){
        print "{$this-&gt;messageA} {$this-&gt;messageB} \n";
    }
}
?&gt;
</PRE><BR><B>diconファイルの作成</B> 
            <UL>
              <LI type=circle>componentタグでコンポーネントを定義します。 
              <LI type=circle>componentタグの子タグのpropertyタグでコンポーネントのプロパティ値を定義します。 
              </LI></UL>
            <P>s2container.php5/src/examples/extension/uuset/uuset.dicon</P><PRE>&lt;components&gt;
    &lt;component class="HelloImpl"&gt;
        &lt;property name="messageA"&gt;"Hello"&lt;/property&gt;
        &lt;property name="messageB"&gt;"World"&lt;/property&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE><BR><B>実行スクリプトの作成</B> 
            <UL>
              <LI 
              type=circle>S2ContainerFactory#create($path)を呼び出してS2Containerを作成します。 

              <LI type=circle>getComponent()を使用して、S2Containerからコンポーネントを取り出します。 
              <LI type=circle>取得したコンポーネントのメソッドを呼び出します。 </LI></UL>
            <P>s2container.php5/src/examples/extension/uuset/uusetClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/uuset.inc.php');
$PATH = EXAMPLE_DIR . "/extension/uuset/uuset.dicon";
$container = S2ContainerFactory::create($PATH);
$hello = $container-&gt;getComponent('HelloImpl');
$hello-&gt;showMessage();
?&gt;
</PRE><BR><B>実行結果</B> 
            <P>propertyタグで指定した文字列が正しく表示されていることが確認できます。</P><PRE>% php uusetClient.php
Hello World
%
</PRE>このexampleは、s2container.php5/src/examples/extension/uuset/以下に用意されています。<BR><BR><A 
            name=ini-dicon>
            <H3>PHP設定ファイル形式のdiconファイル</H3></A>
            <P>PHPの設定ファイル(php.ini等)で使用されるフォーマットで、diconファイルを記述します。<BR>セクションの種類は、componentsセクションと各コンポーネントセクションの2つになります。</P><PRE>[components]
namespace = "dao"
.....
.....
.....
[componentA]                ＋
class = "A"                 ｜
.....                       ｜
.....                       ｜  各コンポーネントセクション
[componentB]                ｜
.....                       ｜
.....                       ｜
.....                       ▽

</PRE><A name=ini-components>
            <H3>components セクション</H3></A>
            <P>componentsセクションには、3つの設定項目があります。componentsセクションは設定の必要がなければ省略できます。 
            <TABLE cellSpacing=0 cellPadding=0 border=0 hspace="0" vspace="0">
              <TBODY>
              <TR>
                <TD>　　　・namespace</TD>
                <TD>　：　</TD>
                <TD>namespaceを設定します。</TD></TR>
              <TR>
                <TD>　　　・include</TD>
                <TD>　：　</TD>
                <TD>includeするdiconファイルのパスを設定します。include{index}で複数設定します。</TD></TR>
              <TR>
                <TD vAlign=top>　　　・meta</TD>
                <TD vAlign=top>　：　</TD>
                <TD><A 
                  href="#ini-meta">metaデータを設定</A>します。 
                </TD></TR></TBODY></TABLE></P><PRE>[components]
namespace = "dao"
include{0} = "/path/to/aaa.dicon"
include{1} = "/path/to/bbb.dicon"
meta{0}{name} = "metaA"
meta{0}{val}  = "meta data"
・・・
・・・
・・・
</PRE><A name=ini-component>
            <H3>component セクション</H3></A>
            <P>componentセクションのセクション名には、コンポーネント名を設定します。class項目が省略されている場合、コンポーネント名がclass名として扱われます。componentセクションには10ヶの設定項目があります。 

            <TABLE cellSpacing=0 cellPadding=0 border=0 hspace="0" vspace="0">
              <TBODY>
              <TR>
                <TD>　　　・class</TD>
                <TD>　：　</TD>
                <TD>class名を設定します。省略した場合はセクション名をclass名とします。</TD></TR>
              <TR>
                <TD>　　　・instance</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="http://s2container.php5.sandbox.seasar.org/DIContainer.html#InstanceMode">instanceモード</A>を設定します。</TD></TR>
              <TR>
                <TD>　　　・autobinding</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="http://s2container.php5.sandbox.seasar.org/DIContainer.html#AutoBindingMode">自動バインディングモード</A>を設定します。</TD></TR>
              <TR>
                <TD>　　　・exp</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="http://s2container.php5.sandbox.seasar.org/php.html">PHP式</A>を記述します。</TD></TR>
              <TR>
                <TD>　　　・arg</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="#ini-arg">コンストラクタ引数を設定</A>します。</TD></TR>
              <TR>
                <TD>　　　・property</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="#ini-property">プロパティを設定</A>します。</TD></TR>
              <TR>
                <TD>　　　・init_method</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="#ini-init_method">initMethodを設定</A>します。</TD></TR>
              <TR>
                <TD>　　　・destroy_method</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="#ini-destroy_method">destroyMethodを設定</A>します。</TD></TR>
              <TR>
                <TD>　　　・aspect</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="#ini-aspect">アスペクトを設定</A>します。</TD></TR>
              <TR>
                <TD>　　　・meta</TD>
                <TD>　：　</TD>
                <TD><A 
                  href="#ini-meta">metaデータを設定</A>します。</TD></TR></TBODY></TABLE></P><PRE>[hello]
class = "Hello"
instance = "singleton"
autobinding = "auto"

arg{0}{val} = "hello world"
arg{1}{ref} = "bye"

property{0}{name} = "message"
property{0}{val} = "hello world 2 !!"

init_method{0}{name} = "initialize"
init_method{0}{arg{0}{val}} = "-1"

aspect{0}{pointcut} = "showMessage"
aspect{0}{exp} = "new TraceInterceptor()"

meta{0}{name} = "helloMeta"
meta{0}{ref} = "bye"

[bye]
class = "Bye"

・・・
・・・
・・・
</PRE><A name=ini-arg>
            <H3>arg設定</H3></A>　　　・arg{index}{val} = 値を設定<BR>　　　・arg{index}{ref} 
            = 参照コンポーネントを指定<BR>　　　・arg{index}{exp} = 
            PHP式を記述<BR>　　　・arg{index}{meta{0}{val}} = <A 
            href="#ini-meta">Metaデータを設定</A><BR><PRE>[hello]
class=Hello
arg{0}{val} = "hello world"
arg{1}{ref} = bye
arg{2}{exp} = "array('hello','world','!!')"

[bye]
class = Bye
</PRE><A name=ini-property>
            <H3>property設定</H3></A>　　　・property{index}{name} = 
            プロパティ名を設定<BR>　　　・property{index}{val} = 
            値を設定<BR>　　　・property{index}{ref} = 
            参照コンポーネントを指定<BR>　　　・property{index}{exp} = 
            PHP式を記述<BR>　　　・property{index}{meta{0}{val}} = <A 
            href="#ini-meta">Metaデータを設定</A><BR><PRE>[hello]
class=Hello

property{0}{name} = "messageA"     --- messageAプロパティに値 Hello を設定
property{0}{val} = "Hello"
property{1}{name} = "messageB"     --- messageBプロパティに値 World を設定
property{1}{val} = "World"
property{2}{name} = "bye"          --- byeプロパティにコンポーネント bye を設定
property{2}{ref} = "bye"

[bye]
class = Bye
</PRE><A name=ini-init_method>
            <H3>init_method設定</H3></A>　　　・init_method{index}{name} = 
            メソッド名を設定<BR>　　　・init_method{index}{arg{0}{val}} = 
            メソッド引数を設定<BR>　　　・init_method{index}{exp} = PHP式を記述<BR><PRE>[hello]
class=Hello

init_method{0}{name} = "showMessage"
init_method{0}{arg{0}{val}} = "Hello"
init_method{0}{arg{1}{val}} = "World"

init_method{1}{exp} = "$component-&gt;initialize()"

</PRE><A name=ini-destroy_method>
            <H3>destroy_method設定</H3></A>
            <P>init_method設定と同様です。</P><A name=ini-aspect>
            <H3>aspect設定</H3></A>　　　・aspect{index}{pointcut} = 
            pointcutを設定<BR>　　　・aspect{index}{ref} = 
            参照コンポーネントを設定<BR>　　　・aspect{index}{exp} = PHP式を記述<BR><PRE>[hello]
class=Hello

aspect{0}{pointcut} = "showMessage"
aspect{0}{ref} = "trace"

[trace]
class = "TraceInterceptor"

</PRE><A name=ini-meta>
            <H3>meta設定</H3></A>
            <P>meta{index}{name}でmeta名、meta{index}{val}で値を設定します。</P>　　　・meta{index}{val} 
            = 値を設定<BR>　　　・meta{index}{ref} = 
            参照コンポーネントを指定<BR>　　　・meta{index}{exp} = PHP式を記述<BR><PRE>[components]
meta{0}{name} = "metaA"
meta{0}{val} = "5"
meta{1}{name} = "metaB"
meta{1}{ref} = hello
meta{2}{name} = "metaC"
meta{2}{exp} = "array('a','b','c')"

[hello]
class = HelloImpl
</PRE><A name=ini-etc>
            <H3>その他</H3></A>
            <UL>
              <LI>項目名にクォートは使用できません。 ( arg{0}{'val'}、arg{0}{"val"} など) 
              <LI>設定値は、ダブルクォートで囲むことで改行が有効となります。 
              <LI>indexは0からの連番になります。 
              <LI>s2container.php5/src/examples/以下の演習で使用するdiconファイルは、XML形式とPHP設定ファイル形式の2種類を用意しています。参照下さい。 
              </LI></UL><BR><A name=dba>
            <H3>データベース接続</H3></A>
            <P>データベースへの接続フレームワークをextennsionとして含めています。 </P>
            <P>以降の説明では、以下のサンプルテーブルを用います。サンプルテーブルを作成する demo.sql は 
            s2container.php5/src/s2container.php5/org/seasar/extension/db/sql/ 
            にあります。 </P>テーブル：EMP 
            <TABLE class=main border=1>
              <TBODY>
              <TR align=middle bgColor=#d1f3f4>
                <TH>カラム名</TH>
                <TH>論理名</TH>
                <TH>型</TH>
                <TH>NotNull</TH>
                <TH>主キー</TH></TR>
              <TR>
                <TD>EMPNO</TD>
                <TD>従業員番号</TD>
                <TD>NUMBER</TD>
                <TD align=middle>〇</TD>
                <TD align=middle>〇</TD></TR>
              <TR>
                <TD>ENAME</TD>
                <TD>従業員名</TD>
                <TD>VARCHAR</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>JOB</TD>
                <TD>仕事</TD>
                <TD>VARCHAR</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>MGR</TD>
                <TD>上司</TD>
                <TD>NUMBER</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>HIREDATE</TD>
                <TD>雇用日</TD>
                <TD>DATE</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>SAL</TD>
                <TD>給料</TD>
                <TD>NUMBER</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>COMM</TD>
                <TD>手数料</TD>
                <TD>NUMBER</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>DEPTNO</TD>
                <TD>部署番号</TD>
                <TD>NUMBER</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>TSTAMP</TD>
                <TD>タイムスタンプ</TD>
                <TD>TIMESTAMP</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR></TBODY></TABLE><BR>テーブル：DEPT 
            <TABLE class=main border=1>
              <TBODY>
              <TR align=middle bgColor=#d1f3f4>
                <TH>カラム名</TH>
                <TH>論理名</TH>
                <TH>型</TH>
                <TH>NotNull</TH>
                <TH>主キー</TH></TR>
              <TR>
                <TD>DEPTNO</TD>
                <TD>部署番号</TD>
                <TD>NUMBER</TD>
                <TD align=middle>〇</TD>
                <TD align=middle>〇</TD></TR>
              <TR>
                <TD>DNAME</TD>
                <TD>部署名</TD>
                <TD>VARCHAR</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>LOC</TD>
                <TD>ロケーション</TD>
                <TD>VARCHAR</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR>
              <TR>
                <TD>VERSIONNO</TD>
                <TD>バージョン番号</TD>
                <TD>NUMBER</TD>
                <TD><BR></TD>
                <TD><BR></TD></TR></TBODY></TABLE><A name=dba-ds>
            <H3>DataSourceについて</H3></A>
            <P>ネイティブのMySQL関数とPostgreSQL関数、Pear 
            DB、ADOdbを用いるデータベース接続について、それぞれDataSource設定diconファイルのテンプレートが、s2container.php5/src/s2container.php5/org/seasar/extension/db/ 
            にあります。 </P>
            <TABLE cellSpacing=1 cellPadding=2 border=1 hspace="0" vspace="0">
              <TBODY>
              <TR align=middle bgColor=#d1f3f4>
                <TH></TH>
                <TH>XML形式 diconファイル</TH>
                <TH>INI形式 diconファイル</TH>
              <TR>
              <TR>
                <TD>ネイティブMySQL関数</TD>
                <TD>mysql.dicon</TD>
                <TD>mysql.ini</TD>
              <TR>
              <TR>
                <TD>ネイティブPostgreSQL関数</TD>
                <TD>postgres.dicon</TD>
                <TD>postgres.ini</TD>
              <TR>
              <TR>
                <TD><A href="http://pear.php.net/package/DB" 
                  target=_blank>Pear DB</A></TD>
                <TD>peardb.dicon</TD>
                <TD>peardb.ini</TD>
              <TR>
              <TR>
                <TD><A href="http://adodb.sourceforge.net/" 
                  target=_blank>ADOdb</A></TD>
                <TD>adodb.dicon</TD>
                <TD>adodb.ini</TD>
              <TR></TR></TBODY></TABLE>　・Pear DB を使用する場合は、予め DB.php 
            をrequireして下さい。<BR>　・ADOdb を使用する場合は、予め adodb-exceptions.inc.php と 
            adodb.inc.php をrequireして下さい。<BR><A name=dba-ds-peardb>
            <H3>peardb.dicon テンプレート</H3></A>
            <P>peardb.diconのテンプレートを以下に示します。 
            dataSourceコンポーネントの各プロパティ設定値を、ご使用のデータベースに接続できる値に設定して下さい。 
            dsnプロパティが設定されている場合は、dsnプロパティ値が優先されます。</P>
            <P>XML形式 peardb.diconファイル</P><PRE>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"components21.dtd"&gt;
&lt;components namespace="peardb"&gt;
    &lt;component name="dataSource" class="PearDBDataSource"&gt;
        &lt;property name="dsn"&gt;                                  
            "mysql://hoge:hoge@localhost:3306/s2container"       
        &lt;/property&gt;                                            
    &lt;/component&gt;

    &lt;component class="PearDBSqlHandler"/&gt;
    &lt;component name="dbtx" class="PearDBTxInterceptor"/&gt;
    &lt;component name="dao" class="SimpleDaoInterceptor"/&gt;
    &lt;component class="DaoMetaDataFactoryImpl"/&gt;
    &lt;component name="session" class="DBSessionImpl"/&gt;
&lt;/components&gt;
</PRE><BR>
            <P>INI形式 peardb.iniファイル</P><PRE>[components]
namespace="peardb"

[dataSource]
class="PearDBDataSource"

property{0}{name}="dsn"                                         
property{0}{val} ="mysql://hoge:hoge@localhost:3306/s2container"

[PearDBSqlHandler]

[dbtx]
class="PearDBTxInterceptor"

[dao]
class="SimpleDaoInterceptor"

[DaoMetaDataFactoryImpl]

[session]
class="DBSessionImpl"
</PRE><A name=dba-ds-use>
            <H3>使用方法</H3></A>
            <P>サンプルとして、引数で受け取ったDEPTNO値でDEPTテーブルを検索し、その結果を返すDAOを実装してみます。<BR>この演習は、s2container.php5/src/examples/extension/db/以下に用意されています。</P>
            <P><B>インタフェースの定義</B></P>
            <UL>
              <LI type=circle>DeptDaoインタフェースを定義します。 
              <LI type=circle>DEPTNO値で検索を行う findDeptByDeptnoメソッドを定義します。 </LI></UL><PRE>&lt;?php
interface DeptDao {
    function findDeptByDeptno($deptno);
}
?&gt;
</PRE>
            <P><B>実装クラスの作成</B></P>
            <UL>
              <LI type=circle>DeptDaoインタフェースを implements する 
              DeptDaoImplクラスを作成します。 
              <LI type=circle>コンストラクタ引数で DataSource を受け取るようにします。 
              <LI type=circle>findDeptByDeptno 
              メソッドを実装します。データベースへのコネクションは、DataSourceより取得します。 </LI></UL><PRE>&lt;?php
class DeptDaoImpl implements DeptDao {

    private $dataSource;

    function DeptDaoImpl(DataSource $dataSource) {
        $this-&gt;dataSource = $dataSource;
    }
    
    function findDeptByDeptno($deptno){
        $db = $this-&gt;dataSource-&gt;getConnection();
        $result = $db-&gt;query("select * from dept where deptno = '{$deptno}';"); 
        $row = $result-&gt;fetchRow();
        $this-&gt;dataSource-&gt;disconnect($db);
        return $row;
    }
}
?&gt;
</PRE>DataSource-&gt;getConnection()の戻り値は、<BR>
            <TABLE cellSpacing=0 cellPadding=0 border=0 hspace="0" vspace="0">
              <TBODY>
              <TR>
                <TD>　　・Pear DBを用いる場合</TD>
                <TD>　:　</TD>
                <TD>DB::connect()の戻り値</TD></TR>
              <TR>
                <TD>　　・ADOdbを用いる場合</TD>
                <TD>　:　</TD>
                <TD>NewADOConnection()の戻り値</TD></TR>
              <TR>
                <TD>　　・MySQL関数を用いる場合</TD>
                <TD>　:　</TD>
                <TD>mysql_connect()の戻り値</TD></TR>
              <TR>
                <TD>　　・PostgreSQL関数を用いる場合</TD>
                <TD>　:　</TD>
                <TD>pg_connect()の戻り値</TD></TR></TBODY></TABLE>となります。どのデータベース接続モジュールを使用するかは、以下のdiconファイルで指定します。<BR><BR>
            <P><B>diconファイルの作成</B></P>
            <P>Pear DB を用いる場合の diconファイルを作成します。includeタグで 
            peardb.diconをインクルードします。 </P>
            <P>XML形式 deptDao.dicon</P><PRE>&lt;components&gt;
    &lt;include path="%S2CONTAINER_PHP5%/org/seasar/extension/db/peardb.dicon"/&gt;
    &lt;component name ="deptDao" class="DeptDaoImpl"/&gt;
&lt;/components&gt;
</PRE>
            <P>INI形式 deptDao.ini</P><PRE>[components]
include{0} = "%S2CONTAINER_PHP5%/org/seasar/extension/db/peardb.dicon"

[deptDao]
class="DeptDaoImpl"
</PRE>
            <P><B>実行スクリプトの作成</B></P>
            <UL>
              <LI type=circle>deptDao.diconを指定してコンテナを作成します。 
              <LI type=circle>コンテナより、deptDaoコンポーネントを取得します。 
              <LI type=circle>DEPTNO(10) で findDeptByDeptno メソッドを呼び出します。 
</LI></UL>
            <P>dataSourceClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/db.inc.php');
$PATH = EXAMPLE_DIR . "/extension/db/deptDao.dicon";
//$PATH = EXAMPLE_DIR . "/extension/db/deptDao.ini";

$container = S2ContainerFactory::create($PATH);
$dao = $container-&gt;getComponent('deptDao');
$result = $dao-&gt;findDeptByDeptno(10);

print_r($result);
?&gt;
</PRE>
            <P><B>実行結果</B></P><PRE>% php dataSourceClient.php
Array
(
    [0] =&gt; 10
    [1] =&gt; ACCOUNTING
    [2] =&gt; NEW YORK
    [3] =&gt; 0
)
%
</PRE><A name=dba-tx>
            <H3>TxIntereceptorを使用する</H3></A>
            <P>TxInterceptorを使用して、データベースへのトランザクションを管理します。<BR>この演習は、s2container.php5/src/examples/extension/db/以下に用意されています。</P>
            <P><B>インタフェースの定義</B></P>
            <UL>
              <LI type=circle>DeptDaoインタフェースを定義します。 
              <LI type=circle>DEPTNO値で検索を行う findDeptByDeptnoメソッドを定義します。 </LI></UL><PRE>&lt;?php
interface DeptDao {
    function findDeptByDeptno($deptno);
}
?&gt;
</PRE>
            <P><B>実装クラスの作成</B></P>
            <UL>
              <LI type=circle>DeptDaoインタフェースを implements する 
              TxDeptDaoImplクラスを作成します。 
              <LI type=circle>コンストラクタ引数で DBSession を受け取るようにします。 
              <LI type=circle>findDeptByDeptno 
              メソッドを実装します。データベースへのコネクションは、DBSessionより取得します。 
            </LI></UL>データベースへの接続、切断や、トランザクションの開始(BEGIN)、COMMITは、TxInterceptorが行います。また 
            Exception が throw された場合は、ROLLBACKを実施します。 <PRE>&lt;?php
class TxDeptDaoImpl implements DeptDao {

    private $session;

    function TxDeptDaoImpl(DBSession $session) {
        $this-&gt;session = $session;
    }
    
    function findDeptByDeptno($deptno){
        $db = $this-&gt;session-&gt;getConnection();
        $result = $db-&gt;query("select * from dept where deptno = '{$deptno}';"); 
        $row = $result-&gt;fetchRow();

        return $row;
    }
}
?&gt;
</PRE>DBSession-&gt;getConnection()の戻り値は、<BR>
            <TABLE cellSpacing=0 cellPadding=0 border=0 hspace="0" vspace="0">
              <TBODY>
              <TR>
                <TD>　　・Pear DBを用いる場合</TD>
                <TD>　:　</TD>
                <TD>DB::connect()の戻り値</TD></TR>
              <TR>
                <TD>　　・ADOdbを用いる場合</TD>
                <TD>　:　</TD>
                <TD>NewADOConnection()の戻り値</TD></TR>
              <TR>
                <TD>　　・MySQL関数を用いる場合</TD>
                <TD>　:　</TD>
                <TD>mysql_connect()の戻り値</TD></TR>
              <TR>
                <TD>　　・PostgreSQL関数を用いる場合</TD>
                <TD>　:　</TD>
                <TD>pg_connect()の戻り値</TD></TR></TBODY></TABLE>となります。<BR><BR>
            <P><B>diconファイルの作成</B></P>
            <P>Pear DB を用いる場合の diconファイルを作成します。includeタグで 
            peardb.diconをインクルードします。 findDeptByDeptnoメソッドに、dbtx 
            (PearDBTxInterceptor) をアスペクトします。 </P>
            <P>XML形式 txDeptDao.dicon</P><PRE>&lt;components&gt;
    &lt;include path="%S2CONTAINER_PHP5%/org/seasar/extension/db/peardb.dicon"/&gt;
    &lt;component name ="deptDao" class="TxDeptDaoImpl"&gt;
        &lt;aspect pointcut="findDeptByDeptno"&gt;
            dbtx
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE>
            <P>INI形式 txDeptDao.ini</P><PRE>[components]
include{0} = "%S2CONTAINER_PHP5%/org/seasar/extension/db/peardb.dicon"

[deptDao]
class="TxDeptDaoImpl"
aspect{0}{pointcut} = "findDeptByDeptno"
aspect{0}{ref} = "dbtx"
</PRE>
            <P><B>実行スクリプトの作成</B></P>
            <UL>
              <LI type=circle>txDeptDao.diconを指定してコンテナを作成します。 
              <LI type=circle>コンテナより、deptDaoコンポーネントを取得します。 
              <LI type=circle>DEPTNO(10) で findDeptByDeptno メソッドを呼び出します。 
</LI></UL>
            <P>txClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/db.inc.php');

$PATH = EXAMPLE_DIR . "/extension/db/txDeptDao.dicon";
//$PATH = EXAMPLE_DIR . "/extension/db/txDeptDao.ini";

$container = S2ContainerFactory::create($PATH);
$dao = $container-&gt;getComponent('deptDao');
$result = $dao-&gt;findDeptByDeptno(10);
print_r($result);
?&gt;
</PRE>
            <P><B>実行結果</B></P><PRE>% php dataSourceClient.php
Array
(
    [0] =&gt; 10
    [1] =&gt; ACCOUNTING
    [2] =&gt; NEW YORK
    [3] =&gt; 0
)
%
</PRE><A name=dba-dao>
            <H3>SimpleDaoInterceptorを使用する<I> (この機能は<A 
            href="http://s2dao.php5.sandbox.seasar.org/">S2Dao.PHP5</A> 
            に移ります)</I></H3></A>
            <P>インタフェース定義とSQL文でデータベース接続を行います。<BR>この演習は、s2container.php5/src/examples/extension/db/以下に用意されています。</P><A 
            name=dba-dao-array>
            <H3>戻り値が配列の場合</H3></A>
            <P>データベース検索結果を配列で取得します。</P>
            <P><B>インタフェースの定義</B></P>
            <UL>
              <LI type=circle>DeptDaoインタフェースを定義します。 
              <LI type=circle>DEPTNO値で検索を行う findDeptByDeptnoメソッドを定義します。 
              <LI type=circle>定数アノテーション(QUERY)で、SQL文を設定します。 </LI></UL><PRE>&lt;?php
interface DeptDao {
    const findDeptByDeptno_QUERY = 'select * from dept where deptno = \'{$deptno}\'';
    //const findDeptByDeptno_FILE = '%PATH_PREFIX%/path/to/sql/file';  // 外部SQLファイルを指定する場合
    function findDeptByDeptno($deptno);
}
?&gt;
</PRE>
            <P>各メソッドが発行するSQL文を指定する方法は3通りあります。<BR>　　　・定数アノテーション： メソッド名_QUERY 
            に記述する (上記サンプル)<BR>　　　・定数アノテーション： メソッド名_FILE で外部ファイルを指定する 
            (パスの先頭に%...%で定数を埋め込めます)<BR>　　　・インタフェース定義ファイルと同じディレクトリに 
            インタフェース名_メソッド名.sql ファイルを作成する<BR></P>
            <P><B>実装クラスの作成</B></P>
            <P>必要な実装クラスはありません。</P>
            <P><B>diconファイルの作成</B></P>
            <P>ADOdb を用いる場合の diconファイルを作成します。includeタグで adodb.diconをインクルードします。 
            findDeptByDeptnoメソッドに、dao(SimpleDaoInterceptor) をアスペクトします。 </P>
            <P>XML形式 simpleDeptDao.dicon</P><PRE>&lt;components&gt;
    &lt;include path="%S2CONTAINER_PHP5%/org/seasar/extension/db/adodb.dicon"/&gt;
    &lt;component name ="deptDao" class="DeptDao"&gt;
        &lt;aspect pointcut="findDeptByDeptno"&gt;
            dao
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE>
            <P>INI形式 simpleDeptDao.ini</P><PRE>[components]
include{0} = "%S2CONTAINER_PHP5%/org/seasar/extension/db/adodb.dicon"

[deptDao]
class="DeptDao"
aspect{0}{pointcut} = "findDeptByDeptno"
aspect{0}{ref} = dao
</PRE>
            <P><B>実行スクリプトの作成</B></P>
            <UL>
              <LI type=circle>simpleDeptDao.diconを指定してコンテナを作成します。 
              <LI type=circle>コンテナより、deptDaoコンポーネントを取得します。 
              <LI type=circle>DEPTNO(10) で findDeptByDeptno メソッドを呼び出します。 
</LI></UL>
            <P>simpleClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/db.inc.php');
$PATH = EXAMPLE_DIR . "/extension/db/simpleDeptDao.dicon";
//$PATH = EXAMPLE_DIR . "/extension/db/simpleDeptDao.ini";

$container = S2ContainerFactory::create($PATH);
$dao = $container-&gt;getComponent('deptDao');
$result = $dao-&gt;findDeptByDeptno(10);
print_r($result);
?&gt;
</PRE>
            <P><B>実行結果</B></P><PRE>% php simpleClient.php
Array
(
    [0] =&gt; Array
        (
            [0] =&gt; 10
            [1] =&gt; ACCOUNTING
            [2] =&gt; NEW YORK
            [3] =&gt; 0
        )
)
%
</PRE><A name=dba-dao-bean>
            <H3>戻り値がオブジェクトの場合</H3></A>
            <P>データベース検索結果を指定したオブジェクトのプロパティ値として取得します。</P>
            <P><B>インタフェースの定義</B></P>
            <UL>
              <LI type=circle>BeanDeptDaoインタフェースを定義します。 
              <LI type=circle>DEPTNO値で検索を行う findDeptByDeptnoメソッドを定義します。 
              <LI type=circle>定数アノテーション(BEAN)で、DTO(Data Transfer Object)を設定します。 
              </LI></UL><PRE>&lt;?php
interface BeanDeptDao {
    const BEAN = "DeptDto";
    function findDeptByDeptno($deptno);
}
?&gt;
</PRE>
            <P>各メソッドが発行するSQL文を指定する方法は3通りあります。<BR>　　　・定数アノテーション： メソッド名_QUERY 
            に記述する<BR>　　　・定数アノテーション： メソッド名_FILE で外部ファイルを指定する 
            (パスの先頭に%...%で定数を埋め込めます)<BR>　　　・インタフェース定義ファイルと同じディレクトリに 
            インタフェース名_メソッド名.sql ファイルを作成する<BR></P>
            <P>3番目の方法を用い、findDeptByDeptnoが発行するSQL文を、BeanDeptDaoインタフェース定義ファイルと同じディレクトリに、 
            BeanDeptDao_findDeptByDeptno.sqlで作成します。 <PRE>select * from dept where deptno = '{$deptno}'
</PRE>
            <P><B>実装クラスの作成</B></P>
            <P>定数アノテーション(BEAN)で指定したDTOを作成します。</P><PRE>&lt;?php
class DeptDto {
    private $deptno;
    private $dname;
    
    function DeptDto() {}
    
    function setDeptno($deptno){
    	$this-&gt;deptno = $deptno;
    }
    function getDeptno(){
        return $this-&gt;deptno;	
    }
    
    function setDname($dname){
    	$this-&gt;dname = $dname;
    }
    function getDname(){
        return $this-&gt;dname;
    }

    function __toString(){
    	$str = "deptno = " . $this-&gt;deptno . ", dname = " . $this-&gt;dname;
        return $str;	
    }
}
?&gt;
</PRE>
            <P>データベース検索結果のうち、カラム名とDTOのプロパティ及びそのセッターメソッド名が対応する値のみ、定数アノテーション(BEAN)で指定した 
            DTO のプロパティに設定されます。</P>　カラム名とプロパティ及びそのセッターメソッド名の対応 
            <TABLE cellSpacing=1 cellPadding=2 border=1 hspace="0" vspace="0">
              <TBODY>
              <TR align=middle bgColor=#d1f3f4>
                <TH>カラム名</TH>
                <TH>プロパティ名</TH>
                <TH>セッターメソッド名</TH>
              <TR>
              <TR>
                <TD>deptno</TD>
                <TD>deptno</TD>
                <TD>setDeptno</TD>
              <TR>
              <TR>
                <TD>dept_no</TD>
                <TD>deptNo</TD>
                <TD>setDeptNo</TD>
              <TR>
              <TR>
                <TD>DEPTNO</TD>
                <TD>deptno</TD>
                <TD>setDeptno</TD>
              <TR>
              <TR>
                <TD>DEPT_NO</TD>
                <TD>deptNo</TD>
                <TD>setDeptNo</TD>
              <TR></TR></TBODY></TABLE><BR>
            <P><B>diconファイルの作成</B></P>
            <P>ADOdb を用いる場合の diconファイルを作成します。includeタグで adodb.diconをインクルードします。 
            findDeptByDeptnoメソッドに、dao(SimpleDaoInterceptor) をアスペクトします。(Pear 
            DBを使用する場合は、peardb.dicon をインクルードして下さい。) </P>
            <P>XML形式 simpleDeptDao.dicon</P><PRE>&lt;components&gt;
    &lt;include path="%S2CONTAINER_PHP5%/org/seasar/extension/db/adodb.dicon"/&gt;
    &lt;component name ="beanDeptDao" class="BeanDeptDao"&gt;
        &lt;aspect pointcut="findDeptByDeptno"&gt;
            dao
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE>
            <P>INI形式 simpleDeptDao.ini</P><PRE>[components]
include{0} = "%S2CONTAINER_PHP5%/org/seasar/extension/db/adodb.dicon"

[beanDeptDao]
class="BeanDeptDao"
aspect{0}{pointcut} = "findDeptByDeptno"
aspect{0}{ref} = dao
</PRE>
            <P><B>実行スクリプトの作成</B></P>
            <UL>
              <LI type=circle>simpleDeptDao.diconを指定してコンテナを作成します。 
              <LI type=circle>コンテナより、beanDeptDaoコンポーネントを取得します。 
              <LI type=circle>DEPTNO(10) で findDeptByDeptno メソッドを呼び出します。 
</LI></UL>
            <P>simpleBeanClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/db.inc.php');
//$PATH = EXAMPLE_DIR . "/extension/db/simpleDeptDao.dicon";
$PATH = EXAMPLE_DIR . "/extension/db/simpleDeptDao.ini";

$container = S2ContainerFactory::create($PATH);
$dao = $container-&gt;getComponent('beanDeptDao');
$result = $dao-&gt;findDeptByDeptno(10);
print_r($result);
?&gt;
</PRE>
            <P><B>実行結果</B></P><PRE>% php simpleBeanClient.php
Array
(
    [0] =&gt; DeptDto Object
        (
            [deptno:private] =&gt; 10
            [dname:private] =&gt; ACCOUNTING
        )

)
%
</PRE>
            <P>DeptDtoクラスのプロパティ deptno と dname 
            に値が設定されています。データベース検索結果のLOCカラムやVERSIONNOカラムのデータは破棄されます。</P><BR><A 
            name=unit>
            <H3>S2Unit</H3></A>
            <P>S2では、コンテナを使った開発のテストを楽しくおこなえるようにテスティングフレームワークが組み込まれています。PHPUnit、PHPUnit2、SimpleTestを拡張しています。主な機能は以下のとおりです。</P>
            <UL>
              <LI>テストメソッド(testXxx)ごとに自動的にS2Containerを作成します。 
              <LI>S2Containerに対するregister()、getComponent()、include() が用意されています。 
              <LI>TestCaseに public 
              なフィールドがあると、フィールド名と同じ名前のコンポーネントがコンテナに存在すれば自動的にセットされます。 
              <LI>テストメソッドが終わると自動セットされた値は自動的にクリア( null をセット)されます。 
              <LI>テストメソッド( testXxx )に対応する setUpXxx()、tearDownXxx() 
              を定義しておくと、setUp()の後、tearDown()の前に自動的に呼び出されます。個別のテストメソッドごとの初期化・終了処理を簡単に行えるようになります。 
              </LI></UL>
            <H3><A name=unit-example>Example</A></H3>
            <P>Pear PHPUnit2 を拡張した S2PHPUnit2TestCase 
            を用います。<BR>このサンプルは、s2container.php5/src/examples/extension/unit/以下にあります。</P>
            <P><B>テスト対象</B></P>
            <P>s2container.php5/src/examples/extension/unit/src/foo/FooLogic.class.php</P><PRE>&lt;?php
class FooLogic {

    function FooLogic() {
    }
    
    function showYear(){
    	return 2005;
    }
}
?&gt;
</PRE>
            <P><B>diconファイル</B></P>
            <P>s2container.php5/src/examples/extension/unit/src/foo/foo.ini</P><PRE>[logic]
class = FooLogic
</PRE>
            <P><B>テストクラス</B></P>
            <P>s2container.php5/src/examples/extension/unit/test/phpunit2/foo/FooLogicTest.class.php</P><PRE>&lt;?php
class FooLogicTest extends S2PHPUnit2TestCase {

    public $logic;   //--- dicon ファイルに logic という名前のコンポーネントが存在すれば設定されます
    
    function __construct($name) {
    	parent::__construct($name);
    }

    function setUp(){
        $this-&gt;includeDicon(UNIT_EXAMPLE . "/src/foo/foo.ini");   //--- dicon ファイルを include します
    }

    function testShowYear(){
        $year = $this-&gt;logic-&gt;showYear();
        $this-&gt;assertEquals($year , 2005);	
    }
}
?&gt;
</PRE>
            <P>s2container.php5/src/examples/extension/unit/test/phpunit2/foo/FooAllTest.class.php</P><PRE>&lt;?php
class FooAllTest {

    public static function main() {
        PHPUnit2_TextUI_TestRunner::run(self::suite());
    }
    
    public static function suite() {
        $suite = new PHPUnit2_Framework_TestSuite();
        $suite-&gt;addTestSuite('FooLogicTest');
        return $suite;  
    }
}
?&gt;
</PRE>
            <P><B>実行スクリプト</B></P>
            <P>s2container.php5/src/examples/extension/unit/test/phpunit2/foo/fooTests.php</P><PRE>&lt;?php
define('PHPUnit2_MAIN_METHOD', 'FooAllTest::main()');
require_once 'PHPUnit2/Framework/TestSuite.php';
require_once 'PHPUnit2/TextUI/TestRunner.php';

FooAllTest::main();
?&gt;
</PRE>
            <P><B>実行結果</B></P><PRE>% php allTests.php

TEST : FooLogicTest::testShowYear
------------------------------------

.

Time: 0.368033

OK (1 test)
%
</PRE>
            <P>Pear PHPUnit と SimpleTest を用いた同様のサンプルが 
            s2container.php5/src/examples/extension/unit/test/以下にあります。</P><!-- document end --><!-- don't edit start --></TD>
          <TD width=14><IMG height=14 alt="" src="../images/spacer.gif" 
            width=14></TD></TR>
        <TR>
          <TD width=14><IMG height=30 alt="" src="../images/spacer.gif" 
            width=14></TD>
          <TD width=766><IMG height=30 alt="" src="../images/spacer.gif" 
            width=592></TD></TR>
        <TR>
          <TD width=14><IMG height=14 alt="" src="../images/spacer.gif" 
            width=14></TD>
<TD class=copyright><TABLE cellSpacing=0 cellPadding=0 width=736><TR><TD align="left">Trans. by H.Ozawa</TD><TD align="right">Copyright&copy; 2004-2005, The Seasar Foundation and 
            the others. All rights reserved.</TD></TR></TABLE></TD></TR></TBODY></TABLE></TD>
    <TD class=backright vAlign=top align=left>&nbsp;</TD></TR>
  <TR>
    <TD class=backunder vAlign=top align=left width=780 height=16>&nbsp;</TD>
    <TD class=backcorner vAlign=top align=left 
height=16>&nbsp;</TD></TR></TBODY></TABLE><!-- don't edit end --></BODY></HTML>
