<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head><title>Seasar - DI Container with AOP - </title><meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
<meta http-equiv="Content-Style-Type" content="text/css">
<link href="../seasar_b.css" type="text/css" rel="stylesheet" media="screen"><script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head>
<BODY onload="preload('en')">
<TABLE cellSpacing=0 cellPadding=0 width="100%" align=left border=0>
  <TBODY>
  <TR>
    <TD vAlign=top align=left width=780>
      <TABLE class=white cellSpacing=0 cellPadding=0 width=780 border=0>
        <TBODY>
        <TR>
          <TD colSpan=7><IMG height=5 alt="" src="../images/top01_b.gif" 
            width=780></TD></TR>
        <TR>
          <TD><IMG height=117 alt=Seasar src="../images/top02_b.gif" 
          width=235></TD>
          <TD colSpan=3><IMG height=117 alt="DI Container with AOP" 
            src="../images/top03.gif" width=289></TD>
          <TD colSpan=3><IMG height=117 alt="" src="../images/spacer.gif" 
            width=256></TD></TR>
<tr><td rowspan="2"><img src="../images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/en/index.html"><img src="../images/menu01_b_en.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/en/projects.html"><img src="../images/menu02_b_en.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/en/products.html"><img src="../images/menu06_b_en.gif" height="30" width="110" border="0" alt="" id="menu06" onmouseover="swap(6)" onmouseout="restore(6)"></a></td>
<td><a href="http://www.seasar.org/en/resources.html"><img src="../images/menu05_b_en.gif" height="30" width="113" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></a></td>
<td><img src="../images/menu07_b_en.gif" height="30" width="109" border="0" alt=""  id="menu07" onmouseover="swap(7)" onmouseout="restore(7)"></td>
<td><img height="30" width="34" src="../images/menu06.gif" alt=""></td></tr><tr>
          <TD colSpan=6><IMG height=19 alt="" src="../images/spacer.gif" 
            width=545></TD></TR></TBODY></TABLE>
      <TABLE class=white cellSpacing=0 cellPadding=0 width=780 border=0>
        <TBODY>
        <TR vAlign=top align=left>
          <TD width=14><IMG height=14 alt="" src="../images/spacer.gif" 
            width=14></TD>
          <TD class=main width=740><!-- don't edit end --><!-- document start -->
            <CENTER>S2Container.PHP5 is a port of Java version Seasar2 to PHP5.<BR>For information on AOP, refer to <A href="http://s2container.seasar.org/en/aop.html">S2AOP</A> page.<BR></CENTER>
            <UL>
              <LI><A href="#S2AOPReference">S2AOP Reference</A> 

              <UL>
                <LI><A href="#AOPMakeFile">Required Files</A> 
                <LI><A  href="#AOPExplanationFile">Configuration File</A> 
                <LI><A href="#AOPInterceptor">S2AOP Interceptor</A> 
                <UL>
                  <LI><A href="#TraceInterceptor">TraceInterceptor</A> 
                  <LI><A href="#ThrowsInterceptor">ThrowsInterceptor</A> 
                  <LI><A href="#MockInterceptor">MockInterceptor</A> 
                  <LI><A href="#DelegateInterceptor">DelegateInterceptor</A> 
                  <LI><A href="#PrototypeDelegateInterceptor">PrototypeDelegateInterceptor</A> 
                  <LI><A href="#InterceptorChain">InterceptorChain</A> 
                  <LI><A href="#OriginalInterceptor">Custom Interceptor</A> 
                  </LI></UL>
                <LI><A href="#nodicon">Using Aspect without a dicon file</A> 
                </LI></UL>
              <LI><A href="#Example">Examples</A> 
              <UL>
                <LI><A href="#TraceInterceptorSample">TraceInterceptor</A> 
                <LI><A href="#ThrowsInterceptorSample">ThrowsInterceptor</A> 
                <LI><A href="#DelegateInterceptorSample">DelegateInterceptor</A> 
                <LI><A href="#PrototypeDelegateInterceptorSample">PrototypeDelegateInterceptor</A> 
                <LI><A href="#OriginalInterceptorSample">Custom Interceptor</A> 
                </LI></UL></LI></UL><BR>
            <H3><A name=Warning>Warnings</A></H3>
            <UL>
              <LI>Aspect may not be applied to a final class
              <LI>Aspect may not be applied to a static method
              <LI>Not specifying a pointcut attribute does not imply all methods - it means only interfaces with implementations. To imply all methods, specify ".*" in pointcut attribute.
              </LI></UL>
            <H2><A name=S2AOPReference>S2AOP Reference</A></H2>
            <H3><A name=AOPMakeFile>Required Files</A></H3>
            <P>S2AOP を使用するにはS2Container 
            の設定ファイル(diconファイル)で行います。設定ファイルの配置場所は、とくに指定がありませんが、通常「Crosscutting 
            Concern」と同じ場所に配置するか、設定を行うコンポーネントと同じ場所に配置します。</P>
            <H3><A name=AOPExplanationFile>Configuration File</A></H3>
            <H4><A name=aspecTtag>aspectタグ（AOPを使用する場合は必須）</A></H4>
            <P>アスペクトをコンポーネントに組み込みます。Interceptorの指定は、ボディでPHP式を使うか、子タグでcomponentタグを使います。<BR>1つのコンポーネントに複数のアスペクトを組み込んだ場合はアスペクトの登録順に組み込まれ実行されます。詳しい説明は<A 
            href="#OriginalInterceptor">独自実装のInterceptor</A>を参照してください。</P>
            <H5>注意点</H5>
            <P>aspectタグで指定されたコンポーネントは、コンテナの初期化時にコンテナから取得されます。そのため、aspectタグで指定されたコンポーネントのinstance属性がprototypeだったとしても、Interceptor 
            のメソッドが呼び出される度に新しいインスタンスが作成されるわけではありません。</P>
            <H5>pointcut属性(任意)</H5>
            <P>カンマ区切りで対象となるメソッド名を指定することができます。pointcutを指定しない場合は、コンポーネントが実装しているインターフェースのすべてのメソッドが対象になります。メソッド名には正規表現も使えます。</P>
            <H5>設定例</H5>
            <P>pointcut 属性を指定してDateのgetTime()メソッドを対象とする場合以下のようになります。 
            pointcut属性を指定しない場合はDateが実装しているインターフェースのメソッドが対象になります。</P><PRE>&lt;?php
class Date {
    function Date() {}
    
    function getTime(){
        return '12:00:30';
    }

    function getDate(){
        return '25';
    }
}
?&gt;
</PRE>正規表現を使ってjava.util.Dateのpublicなメソッドすべてを対象としたい場合は、以下のように設定します。 <PRE>&lt;component class="Date"&gt;
    &lt;aspect pointcut=".*"&gt;
        &lt;component class="TraceInterceptor"/&gt;
    &lt;/aspect&gt;
&lt;/component&gt;
</PRE>
            <H3><A name=AOPInterceptor>S2AOPで用意されているInterceptor</A></H3>
            <P>S2AOPでは、以下のInterceptorを用意しています。また独自のInterceptorを簡単に作成できるようになっています。</P>
            <H4><A name=TraceInterceptor>(1) TraceInterceptor</A></H4>
            <H5>クラス名</H5>
            <P>TraceInterceptor</P>
            <H5>説明</H5>
            <P>トレース処理を「Crosscutting 
            Concern」として扱うためのInterceptorです。DateクラスにTraceInterceptorを適用したdiconファイルは、以下のようになります。対象とするメソッドはgetTime()とします。</P><PRE>&lt;component class="Date"&gt;
    &lt;aspect pointcut="getTime"&gt;
        &lt;component class="TraceInterceptor"/&gt;
    &lt;/aspect&gt;
&lt;/component&gt;
</PRE>
            <P>詳しい使用方法は<A 
            href="#TraceInterceptorSample">TraceInterceptor</A>を参照してください。</P>
            <H4><A name=ThrowsInterceptor>(2) ThrowsInterceptor</A></H4>
            <H5>クラス名</H5>
            <P>ThrowsInterceptor</P>
            <H5>説明</H5>
            <P>例外処理を「Crosscutting 
            concern」として扱うためのInterceptorです。使用するにはThrowsInterceptorを継承し、function 
            handleThrowable(Exception, MethodInvocation)を実装するだけです。詳しい使用方法は<A 
            href="#ThrowsInterceptorSample">ThrowsInterceptor</A>を参照してください。</P>
            <H4><A name=MockInterceptor>(3) MockInterceptor</A></H4>
            <H5>クラス名</H5>
            <P>MockInterceptor</P>
            <H5>説明</H5>
            <P>Mockを使ったテストを簡単に行うためのInterceptorです。詳しい説明はテスト技法の<A 
            href="http://homepage3.nifty.com/seasar/testtech.html#MockMake">モックを作成するための設定</A>を参照してください。</P>
            <H4><A name=DelegateInterceptor>(4) DelegateInterceptor</A></H4>
            <H5>クラス名</H5>
            <P>DelegateInterceptor</P>
            <H5>説明</H5>
            <P>メソッド呼び出しを別のコンポーネントに委譲するためのInterceptorです。使用方法はDelegateInterceptorのtargetプロパティに委譲したい相手を指定します。委譲するときのメソッド名が異なる場合には、 
            DeleateInterceptor#addMethodNameMap( $methodName, 
            $targetMethodName)で指定します。例えば、bar()というメソッドをfoo-&gt;bar2()に委譲する場合、 
            DeleateInterceptor#setTarget(foo)，DeleateInterceptor#addMethodNameMap 
            ("bar", "bar2")のように指定します。詳しい使用方法は<A 
            href="#DelegateInterceptorSample">DelegateInterceptor</A>を参照してください。</P>
            <H5>注意</H5>
            <P>targetプロパティに指定されたコンポーネントは、コンテナの初期化時にコンテナから取得されます。このため、targetプロパティに指定されたコンポーネントのinstance属性がprototypeであっても、常に同じインスタンスが使われます。メソッド呼び出しの度に新しいインスタンスをコンテナから取得したい場合は次のPrototypeDelegateInterceptorを使用してください。</P>
            <H4><A name=PrototypeDelegateInterceptor>(5) 
            PrototypeDelegateInterceptor</A></H4>
            <H5>クラス名</H5>
            <P>PrototypeDelegateInterceptor</P>
            <H5>説明</H5>
            <P>メソッド呼び出しを別のコンポーネントに委譲するためのInterceptorです。メソッド呼び出しの度にコンポーネントをコンテナから取得します。使用方法はPrototypeDelegateInterceptorのtargetNameプロパティに委譲したい相手の名前を指定します。委譲するときのメソッド名が異なる場合には、PrototypeDeleateInterceptor#addMethodNameMap($methodName, 
            $targetMethodName)で指定します。例えば、bar()というメソッドをfoo-&gt;bar2()に委譲する場合、 
            PrototypeDeleateInterceptor#setTarget(foo)， 
            PrototypeDeleateInterceptor#addMethodNameMap("bar", 
            "bar2")のように指定します。詳しい使用方法は<A 
            href="#PrototypeDelegateInterceptorSample">PrototypeDelegateInterceptor</A>を参照してください。</P>
            <H4><A name=InterceptorChain>(6) InterceptorChain</A></H4>
            <H5>クラス名</H5>
            <P>InterceptorChain</P>
            <H5>説明</H5>
            <P>複数のInterceptorをグルーピング化し、再利用しやすくします。複数のInterceptorの組み合わせを複数コンポーネントに適用する場合は、InterceptorChainで複数のInterceptor1つにまとめて、各コンポーネントにはInterceptorChainを指定するようにするといいでしょう。</P><PRE>&lt;component name="interceptor1" .../&gt;
&lt;component name="interceptor2" .../&gt;
&lt;component name="interceptor3" .../&gt;<BR>&lt;component name="chain" class="InterceptorChain"&gt;<BR>    &lt;initMethod name="add"&gt;&lt;arg&gt;interceptor1&lt;/arg&gt;&lt;/initMethod&gt;<BR>    &lt;initMethod name="add"&gt;&lt;arg&gt;interceptor2&lt;/arg&gt;&lt;/initMethod&gt;<BR>    &lt;initMethod name="add"&gt;&lt;arg&gt;interceptor3&lt;/arg&gt;&lt;/initMethod&gt;<BR>&lt;/component&gt;
&lt;component ...&gt;
    &lt;aspect&gt;chain&lt;/aspect&gt;
&lt;/component&gt;
&lt;component ...&gt;
    &lt;aspect&gt;chain&lt;/aspect&gt;
&lt;/component&gt;</PRE>
            <H4><A name=OriginalInterceptor>(7) 独自実装によるInterceptor</A></H4>
            <H5>説明</H5>
            <P>独自にInterceptorを作成する場合は、次のインターフェースまたは、抽象クラスを実装します。</P>
            <DL>
              <DT style="TEXT-INDENT: 1em">MethodInterceptor 
              <DT style="TEXT-INDENT: 1em">AbstractInterceptor </DT></DL>
            <P>どちらの場合も実装するメソッドは、以下のinvoke()メソッドの１つだけです。</P>
            <DL>
              <DT style="TEXT-INDENT: 1em">public function 
              invoke(MethodInvocation $methodInvocation) </DT></DL>
            <P>AbstractInterceptor 
            は、MethodInterceptorをimplementsした抽象クラスです。AbstractInterceptorには、Proxyオブジェクトを取得するcreateProxy()メソッドとアスペクトを適用するクラスを取得するgetTargetClass()メソッドがあります。アスペクトを適用したクラス名を必要とするInterceptor(例えば、ログ出力を行うInterceptor)を作成する場合は、 
            AbstractInterceptorを使用することで簡単にクラス名を取得することができます。</P>
            <DL>
              <DT style="TEXT-INDENT: 1em">public function 
              createProxy($proxyClass) 
              <DT style="TEXT-INDENT: 1em">protected function 
              getTargetClass(MethodInvocation $methodInvocation) </DT></DL>
            <P>MethodInvocation 
            のgetThis()、getMethod()、getArguments()で対象となるオブジェクト、メソッド、引数を取得できます。proceed()を呼び出すと実際のメソッドが呼び出され実行結果を取得することができます。以下のような独自のInterceptorを作成したとします。</P>
            <H5>作成例</H5><PRE>&lt;?php
class ABS implements MethodInterceptor {
    public function invoke(MethodInvocation $invocation){

        print "Before \n";             &lt;-- 呼ぶ前は Before

        $ret = $invocation-&gt;proceed();

        print "After \n";              &lt;-- 呼んだ後は After

        return $ret;
    }
}
?&gt;
</PRE>
            <P>MethodInvocation#proceed()を呼ぶ前と後で2分され、呼ぶ前は 
            Beforeの個所を実行し、呼んだ後はAfterの個所を実行します。1つのコンポーネントに複数のアスペクトが定義されている場合は、以下のよう実行されます。</P>
            <OL>
              <LI>Aspectの登録順にMethodInterceptorのbefore部分が実行されます。 
              <LI>最後のMethodInterceptorのbefore部分を実行した後にコンポーネント自身のメソッドが呼び出されます。 
              <LI>Aspectの登録の逆順にMethodInterceptorのafter部分が実行されます。 </LI></OL>
            <P>詳しい使用方法は<A 
            href="#OriginalInterceptorSample">独自実装によるInterceptor</A>を参照してください。</P>
            <H3><A name=nodicon>diconファイルを使用しないでアスペクトを組み込む方法</A></H3>
            <P>diconファイルの設定を行わずプログラム上でアスペクトを組み込むこともできます。作成方法は次のようになります。</P>
            <UL>
              <LI>PointcutImpl 
              のコンストラクタの引数で対象となるメソッド名を指定(複数可)しますクラスを指定することで、そのクラスが実装しているインターフェースのメソッドをすべて自動的に適用させることもできます。 

              <LI>AspectImplのコンストラクタの第1引数にInterceptorを指定して、第2引数にPointcutImplで作成したPointcutを指定します。 

              <LI>AopProxyのコンストラクタで、対象となるクラスとAspectImplで作成したAspectの配列を指定します。 
              <LI>AopProxy#create()でAspectが適用されたオブジェクトを取得できます。 </LI></UL>
            <P>DateクラスにTraceInterceptorをプログラム上で適用する場合は、次のようになります。対象となるメソッドはgetTime()とします。</P><PRE>&lt;?php
$pointcut = new PointcutImpl(array("getTime"));
$aspect = new AspectImpl(new TraceInterceptor(), $pointcut);
$aopProxy = new AopProxy('Date', array($aspect));
$proxy = $aopProxy-&gt;create();
$proxy-&gt;getTime();
?&gt;
</PRE><BR>
            <H2><A name=Example>Example</A></H2>
            <P>以下のサンプルを実行する場合は、<A 
            href="http://s2container.php5.sandbox.seasar.org/setup.html">セットアップ</A>を行う必要があります。</P>
            <H3><A name=TraceInterceptorSample>TraceInterceptor</A></H3>
            <P>TraceInterceptor 
            を使用してDateクラスのgetTime()メソッドが呼ばれた場合にトレースを出力させましょう。作成するファイルは以下のとおりです。</P>
            <UL>
              <LI type=circle>コンポーネントを定義するdiconファイル(Trace.dicon) 
              <LI type=circle>設定が正しく行われているか確認する実行スクリプト(AopTraceClient.php) 
            </LI></UL>
            <P><B>diconファイルの作成</B></P>
            <UL>
              <LI 
              type=circle>TraceInterceptorをコンポーネント定義します。name属性をtraceInterceptorとします。 

              <LI type=circle>Date 
              クラスのコンポーネントの定義します。pointcut属性にgetTime()メソッドを指定します。aspectタグにInterceptorを指定します。 
              </LI></UL>
            <P>Trace.dicon</P><PRE>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component name="traceInterceptor" class="TraceInterceptor"/&gt;
    &lt;component class="Date"&gt;
        &lt;aspect pointcut="getTime"&gt;
            traceInterceptor
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE>
            <P><B>実行スクリプトの作成</B></P>
            <UL>
              <LI 
              type=circle>S2Container#create()メソッドの最初の引数に作成したdiconファイル(Trace.dicon)のパスを指定してコンテナを作成します。 

              <LI type=circle>S2Container#getComponent 
              ()メソッドの第１引数にコンポーネントに登録したクラス名（Date)を指定してコンポーネントを取得します。 
              <LI 
              type=circle>トレースがAspectされるか確認するために取得したコンポーネントのDateのgetTime()メソッドを実行します。 
              </LI></UL>
            <P>AopTraceClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/trace.inc.php');

$PATH = EXAMPLE_DIR . "/aop/traceinterceptor/Trace.dicon";

$container = S2ContainerFactory::create($PATH);
$date = $container-&gt;getComponent('Date');
$date-&gt;getTime();
?&gt;
</PRE>
            <P><B>実行結果</B></P>
            <P>メソッドが呼ばれる前と後でトレースが出力されているのが確認できます。</P><PRE>% php AopTraceClient.php
BEGIN Date#getTime()
END   Date#getTime() : 12:00:30
%
</PRE>
            <P>このサンプルは、s2container.php5/src/examples/aop/traceinterceptor以下に用意されています。</P><BR>
            <H3><A name=ThrowsInterceptorSample>ThrowsInterceptor</A></H3>
            <P>(1) 
            ThrowsInterceptorを使って、例外が発生した場合でも処理を続けられるようにしましょう。作成するファイルは以下のようになります。</P>
            <UL>
              <LI type=circle>Exceptionを発生させるクラス(Checker.class.php) 
              <LI 
              type=circle>ThrowsInterceptorを継承して作成するInterceptor(HandleThrowableInterceptor.class.php) 

              <LI type=circle>コンポーネントの定義をするdiconファイル(Checker.dicon) 
              <LI type=circle>設定が正しく行われているか確認する実行ファイル(AopCheckerClient.php) 
            </LI></UL>
            <P><B>例外を発生させるクラスの作成</B></P>
            <UL>
              <LI type=circle>run()メソッドの引数がnullでは無い場合は、引数の文字をコンソールに出力します。 
              <LI type=circle>引数がnullの場合は、Exceptionを発生させます。 </LI></UL>
            <P>Checker.class.php</P><PRE>&lt;?php
class Checker {
    public function check($str) {
        if ($str != null) {
            print $str . "\n";
        } else {
            throw new Exception("null");
        }
    }
}
?&gt;
</PRE>
            <P><B>ThrowsInterceptorを継承するInterceptorの作成</B></P>
            <UL>
              <LI type=circle>ThrowsInterceptorを継承します。 
              <LI type=circle>handleThrowable(Exception, 
              MethodInvocation)を実装します。 </LI></UL>
            <P>HandleThrowableInterceptor.class.php</P><PRE>&lt;?php
class HandleThrowableInterceptor extends ThrowsInterceptor {
	
    public function handleThrowable(Exception $t, MethodInvocation $invocation){
    }
}
?&gt;
</PRE>
            <P><B>diconファイルの作成</B></P>
            <UL>
              <LI 
              type=circle>作成したInterceptorをコンポーネント定義します。name属性をhandleThrowableInterceptorとします。 

              <LI 
              type=circle>例外を発生させるCheckerクラスのcheck()メソッドに作成したHandleThrowableInterceptorをアスペクトします。 
              </LI></UL>
            <P>Checker.dicon</P><PRE>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component name="handleThrowableInterceptor" class="HandleThrowableInterceptor"/&gt;
    &lt;component class="Checker"&gt;
        &lt;aspect pointcut="check"&gt;
            handleThrowableInterceptor
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE>
            <P><B>実行ファイルの作成</B></P>
            <UL>
              <LI 
              type=circle>S2Container#create()メソッドの第１引数に作成したdiconファイル(Checker.dicon)のパスを指定してコンテナを作成します。 

              <LI 
              type=circle>S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（Foo.class)を指定して取得します。 

              <LI type=circle>Checker#check()メソッドの引数に"foo"の文字列を渡します。 
              <LI type=circle>Checker#check()メソッドの引数にnullを渡して例外を発生させます。 
              <LI type=circle>Checker#check()メソッドの引数に"hoge"の文字列を渡します。 </LI></UL>
            <P>AopCheckerClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/throws.inc.php');

$PATH = EXAMPLE_DIR . "/aop/throwsinterceptor/Checker.dicon";
$container = S2ContainerFactory::create($PATH);
$checker = $container-&gt;getComponent('Checker');
try{
    $checker-&gt;check("foo");
}catch(Exception $e){
    print "Exception : " . $e-&gt;getMessage() . "\n";
}

try{
    $checker-&gt;check(null);
}catch(Exception $e){
    print "Exception : " . $e-&gt;getMessage() . "\n";
}

try{
    $checker-&gt;check("hoge");
}catch(Exception $e){
    print "Exception : " . $e-&gt;getMessage() . "\n";
}
?&gt;
</PRE>
            <P><B>実行結果</B></P>
            <P>例外で処理が止まっていないことが確認できます。</P><PRE>% php AopCheckerClient.php
foo
hoge
%
</PRE>
            <P>このサンプルは、s2container.php5/src/examples/aop/throwsinterceptor以下に用意されています。</P><BR>
            <P>(2) 
            例外を別の例外に変換するInterceptorを作成して変換したメッセージを表示させましょう。作成するInterceptorは、先ほど 
            ThrowsInterceptorを継承して作成したクラス(HandleThrowableInterceptor.class.php)を応用して作成しましょう</P>　 
            <B>例外を別の例外に変換するInterceptorの作成</B> 
            <P>S2RuntimeExceptionを発生させてメッセージを変更します。</P><PRE>&lt;?php
class HandleThrowableInterceptor extends ThrowsInterceptor {
	
    public function handleThrowable(Exception $t, MethodInvocation $invocation){
        throw new S2RuntimeException("ESSR0007", array("arg"));
    }
}
?&gt;
</PRE>
            <P>先ほど作成した実行ファイルを使って実行します。</P><B>実行結果</B> 
            <P>エラーメッセージが変わっているのが確認できます。</P><PRE>% php AopCheckerClient.php
foo
Exception : arg should not be null or empty
hoge
%
</PRE>
            <P>このサンプルは、s2container.php5/src/examples/aop/throwsinterceptor以下に用意されています。</P>
            <H3><A name=DelegateInterceptorSample>DelegateInterceptor</A></H3>
            <P>S2AOPで用意されているDelegateInterceptorを使って、他のクラスのメソッドに委譲させましょう。<BR>ここでは、インターフェースで抽象メソッドを作成して、抽象クラスと普通のクラスの両方にそのインターフェースを実装させます。抽象クラスで実装したメソッドを普通のクラスで実装したメソッドに委譲させましょう。作成するファイルは以下のとおりです。</P>
            <UL>
              <LI type=circle>インターフェース(IBase.class.php) 
              <LI type=circle>インターフェースを実装した抽象クラス(Dummy.class.php) 
              <LI type=circle>インターフェースを実装したクラス(Substance.class.php) 
              <LI type=circle>委譲を設定するdiconファイル(Delegate.dicon) 
              <LI 
              type=circle>設定が正しく行われているか確認する実行ファイル(AopDelegateClient.class.php) 
              </LI></UL>
            <P><B>インターフェースの作成</B></P>
            <UL>
              <LI type=circle>抽象メソッドを作成します。 </LI></UL>
            <P>IBase.class.php</P><PRE>&lt;?php
interface IBase {
    public function run();
}
?&gt;
</PRE>
            <P><B>インターフェースを実装した抽象クラスの作成</B></P>
            <UL>
              <LI type=circle>作成したインターフェースを実装します。 </LI></UL>
            <P>Dummy.class.php</P><PRE>&lt;?php
abstract class Dummy implements IBase {
}
?&gt;
</PRE>
            <P><B>インターフェースを実装したクラスの作成</B></P>
            <UL>
              <LI type=circle>作成したインターフェースを実装します。 
              <LI type=circle>実装したインタフェースの抽象メソッドの実装します。 </LI></UL>
            <P>Substance.class.php</P><PRE>&lt;?php
class Substance implements IBase{
    public function run() {
        print "substance\n";
    }
}
?&gt;
</PRE>
            <P><B>diconファイルの作成</B></P>
            <UL>
              <LI type=circle>抽象クラス(Dummy)をコンポーネント定義します。 
              <LI type=circle>DelegateInterceptor 
              のコンポーネントをaspectタグに定義します。DelegateInterceptor#setTarget()を使って委譲したい相手を指定します。委譲したいクラスはSubstanceクラスなのでメソッド・インジェクションを使ってセットします。 
              </LI></UL>
            <P>Delegate.dicon</P><PRE>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component class="Dummy"&gt;
        &lt;aspect&gt;
            &lt;component class="DelegateInterceptor"&gt;
                &lt;initMethod name="setTarget"&gt;
                    &lt;arg&gt;new Substance()&lt;/arg&gt;
                &lt;/initMethod&gt;
            &lt;/component&gt;
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;</PRE>
            <P><B>実行ファイルの作成</B></P>
            <UL>
              <LI 
              type=circle>S2Container#create()メソッドの最初の引数に作成したdiconファイル(Delegate.dicon)のパスを指定してコンテナを作成します。 

              <LI 
              type=circle>S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（IBase)を指定して取得します。 

              <LI type=circle>コンテナから取得したIBase#run()メソッドを実行します。 
            </LI></UL>AopDelegateCilent.php <PRE>&lt;?php
require_once(dirname(__FILE__) . '/delegate.inc.php');
$PATH = EXAMPLE_DIR . "/aop/delegateinterceptor/Delegate.dicon";
$container = S2ContainerFactory::create($PATH);
$base = $container-&gt;getComponent('Dummy');
$base-&gt;run();
?&gt;
</PRE>
            <P><B>実行結果</B></P>
            <P>コンソールに"substance"と表示されているのでDummy#run()がSubstance#run()に委譲されているのが確認できます。</P><PRE>% php AopDelegateCilent.php
substance
%
</PRE>
            <P>このサンプルは、s2container.php5/src/examples/aop/delegateinterceptor以下に用意されています。</P><BR>
            <H3><A 
            name=PrototypeDelegateInterceptorSample>PrototypeDelegateInterceptor</A></H3>
            <P>S2AOPで用意されているPrototypeDelegateInterceptorを使って、singletonのコンポーネントからprototypeのコンポーネントのメソッドに委譲させましょう。<BR>ここでは、インターフェースで抽象メソッドを作成して、抽象クラス(singleton)と普通のクラス(prototype)の両方にそのインターフェースを実装させます。抽象クラスで実装したメソッドを普通のクラスで実装したメソッドに委譲させましょう。作成するファイルは以下のとおりです。</P>
            <UL>
              <LI type=circle>インターフェース(IBase.class.php) 
              <LI type=circle>インターフェースを実装したsingletonの抽象クラス(Dummy.class.php) 
              <LI type=circle>インターフェースを実装したprototypeのクラス(Substance.class.php) 
              <LI type=circle>委譲を設定するdiconファイル(Delegate.dicon) 
              <LI 
              type=circle>設定が正しく行われているか確認する実行ファイル(AopPrototypeDelegateClient.php) 
              </LI></UL>
            <P><B>インターフェースの作成</B></P>
            <UL>
              <LI type=circle>抽象メソッドを作成します。 </LI></UL>
            <P>IBase.class.php</P><PRE>&lt;?php
interface IBase {
    public abstract function run();
}
?&gt;
</PRE>
            <P><B>インターフェースを実装した抽象クラスの作成</B></P>
            <UL>
              <LI type=circle>作成したインターフェースを実装します。 </LI></UL>
            <P>Dummy.class.php</P><PRE>&lt;?php
abstract class Dummy implements IBase {
}
?&gt;
</PRE>
            <P><B>インターフェースを実装したクラスの作成</B></P>
            <UL>
              <LI type=circle>作成したインターフェースを実装します。 
              <LI type=circle>実装したインタフェースの抽象メソッドの実装します。 </LI></UL>
            <P>Substance.class.php</P><PRE>&lt;?php
class Substance implements IBase{
    private $sum = 0;

    public function run() {
        print "sum : " . $this-&gt;sum . "\n";
        $this-&gt;sum++;
    }
}
?&gt;
</PRE>
            <P><B>diconファイルの作成</B></P>
            <UL>
              <LI type=circle>抽象クラス(Dummy)をコンポーネント定義します。このコンポーネントはsingletonです。 
              <LI 
              type=circle>PrototypeDelegateInterceptorのコンポーネントをaspectタグに定義します。PrototypeDelegateInterceptorのtargetNameプロパティに委譲したい相手の名前("target")を指定します。 

              <LI 
              type=circle>委譲したいクラス(Substance)をコンポーネント定義します。このコンポーネントのinstance属性はprototypeです。 
              </LI></UL>
            <P>PrototypeDelegate.dicon</P><PRE>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component class="Dummy"&gt;
        &lt;aspect&gt;
            &lt;component class="PrototypeDelegateInterceptor"&gt;
                &lt;property name="targetName"&gt;"target"&lt;/property&gt;
            &lt;/component&gt;
        &lt;/aspect&gt;
    &lt;/component&gt;

    &lt;component name="target" class="Substance" instance="prototype"/&gt;
&lt;/components&gt;</PRE>
            <P><B>実行ファイルの作成</B></P>
            <UL>
              <LI 
              type=circle>S2Container#create()メソッドの最初の引数に作成したdiconファイル(PrototypeDelegate.dicon)のパスを指定してコンテナを作成します。 

              <LI 
              type=circle>S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（IBase)を指定して取得します。 

              <LI type=circle>コンテナから取得したIBase#run()メソッドを繰り返し実行します。 
            </LI></UL>AopPrototypeDelegateCilent.php <PRE>&lt;?php
require_once(dirname(__FILE__) . '/prototype.inc.php');

$PATH = EXAMPLE_DIR . "/aop/prototypedelegateinterceptor/PrototypeDelegate.dicon";
$container = S2ContainerFactory::create($PATH);
$base = $container-&gt;getComponent('Dummy');
for ($i = 0; $i &lt; 5; ++$i) {
   $base-&gt;run();
}
?&gt;
</PRE>
            <P><B>実行結果</B></P>
            <P>コンソールに"sum : 0"と表示されているので 
            Dummy#run()がSubstance#run()に委譲されているのが確認できます。また、sumの値がすべて"0"となっていることから，run()メソッドを呼び出すたびに新しいSubstanceのインスタンスが作成されていることが分かります。</P><PRE>% php AopPrototypeDelegateCilent.php
sum : 0
sum : 0
sum : 0
sum : 0
sum : 0
%
</PRE>
            <P>このサンプルは、s2container.php5/src/examples/aop/delegateinterceptor以下に用意されています。</P><BR>
            <H3><A name=OriginalInterceptorSample>独自実装によるInterceptor</A></H3>
            <P>クラス名、メソッド名、引数とメソッドの処理時間を計測してトレースするInterceptorを作成しましょう。また、そのInterceptorを使用して重い処理を行った時間をトレースさせましょう。作成するファイルは以下のとおりです。</P>
            <UL>
              <LI 
              type=circle>クラス名、メソッド名、引数とメソッドの処理時間を計測して出力するInterceptor(MeasurementInterceptor.java) 

              <LI type=circle>重い処理を行うクラス(HeavyProcess.java) 
              <LI type=circle>コンポーネントの定義を行うdiconファイル(Measurement.dicon) 
              <LI type=circle>設定が正しく行われているか確認する実行ファイル(AopMeasurementClient.java) 
              </LI></UL>
            <P><B>独自実装のIntercepterの作成</B></P>
            <UL>
              <LI type=circle>AbstractInterceptorクラスを実装します。 
              <LI type=circle>invoke(MethodInvocation $invocation)メソッドを実装します。 
              <LI 
              type=circle>getTargetClass($invocation)-&gt;getName()でクラス名を取得します。 
              <LI 
              type=circle>$invocation-&gt;getMethod()-&gt;getName()でメソッド名を取得します。 

              <LI type=circle>$invocation-&gt;getArguments()で引数を取得します。 
              <LI 
              type=circle>$invocation-&gt;proceed()で実際のメソッドが呼ばれるので、その前の時間を取得します。 
              </LI></UL>
            <P>MeasurementInterceptor.class.php</P><PRE>&lt;?php
class MeasurementInterceptor extends AbstractInterceptor {
    public function invoke(MethodInvocation $invocation){
        $start = 0;
        $end = 0;
        $buf = "";

        $buf = $this-&gt;getTargetClass($invocation)-&gt;getName();
        $buf .= "#";
        $buf .= $invocation-&gt;getMethod()-&gt;getName();
        $buf .= "(";
        $args = $invocation-&gt;getArguments();
        $buf .= implode($args) . ")";
        try {
            $start = $this-&gt;microtime_float();
            $ret = $invocation-&gt;proceed();
            $end = $this-&gt;microtime_float();
            $buf .= " : ";
            $t = $end - $start;
	    print $buf . $t . "\n";
            return $ret;
        } catch (Exception $t) {
            $buf .= " Exception:";
            $buf .= $t-&gt;getMessage();
            throw $t;
        }
    }
	
    private function microtime_float() {
        list($usec, $sec) = explode(" ", microtime());
        return ((float)$usec + (float)$sec);
    } 
}
?&gt;
</PRE>
            <P><B>重い処理を行うクラスの作成</B></P>
            <UL>
              <LI type=circle>重い処理を行ったということにするために5秒間sleepします。 </LI></UL>
            <P>HeavyProcess.class.php</P><PRE>&lt;?php
class HeavyProcess {
    public function heavy(){
    	sleep(5);
    }
}
?&gt;
</PRE><B>diconファイルの作成</B> 
            <UL>
              <LI 
              type=circle>作成したMeasurementInterceptorをコンポーネント定義します。name属性をmeasurementとします。 

              <LI 
              type=circle>HeavyProcessクラスのheavy()メソッドにMeasurementInterceptorをaspectします。 
              </LI></UL>
            <P>Measurement.dicon</P><PRE>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components32.dtd"&gt;
&lt;components&gt;
    &lt;component name="measurement" class="MeasurementInterceptor"/&gt;
    &lt;component class="HeavyProcess"&gt;
        &lt;aspect pointcut="heavy"&gt;
               measurement
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</PRE>
            <P><B>実行ファイルの作成</B></P>
            <UL>
              <LI 
              type=circle>S2Container#create()メソッドの第１引数に作成したdiconファイル(Measurement.dicon)のパスを指定してコンテナを作成します。 

              <LI 
              type=circle>S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（HeavyProcess)を指定して取得します。 

              <LI type=circle>コンテナから取得したHeavyProcess#heavy()メソッドを実行します。 </LI></UL>
            <P>AopMeasurementClient.php</P><PRE>&lt;?php
require_once(dirname(__FILE__) . '/original.inc.php');
$PATH = EXAMPLE_DIR . "/aop/originalinterceptor/Measurement.dicon";

$container = S2ContainerFactory::create($PATH);
$heavyProcess = $container-&gt;getComponent('HeavyProcess');
$heavyProcess-&gt;heavy();
?&gt;
</PRE>
            <P><B>実行結果</B></P>
            <P>クラス名、メソッド名、引数とメソッドの処理時間がトレースされているのが確認できます。</P><PRE>% php AopMeasurementClient.php
HeavyProcess#heavy() : 5.0025010108948
%
</PRE>
            <P>このサンプルは、s2container.php5/src/examples/aop/originalinterceptor以下に用意されています。</P><!-- document end --><!-- don't edit start --></TD>
          <TD width=14><IMG height=14 alt="" src="../images/spacer.gif" 
            width=14></TD></TR>
        <TR>
          <TD width=14><IMG height=30 alt="" src="../images/spacer.gif" 
            width=14></TD>
          <TD width=766><IMG height=30 alt="" src="../images/spacer.gif" 
            width=592></TD></TR>
        <TR>
          <TD width=14><IMG height=14 alt="" src="../images/spacer.gif" 
            width=14></TD>
<TD class=copyright><TABLE cellSpacing=0 cellPadding=0 width=736><TR><TD align="left">Trans. by H.Ozawa</TD><TD align="right">Copyright&copy; 2004-2005, The Seasar Foundation and 
            the others. All rights reserved.</TD></TR></TABLE></TD></TR></TBODY></TABLE></TD>
    <TD class=backright vAlign=top align=left>&nbsp;</TD></TR>
  <TR>
    <TD class=backunder vAlign=top align=left width=780 height=16>&nbsp;</TD>
    <TD class=backcorner vAlign=top align=left 
height=16>&nbsp;</TD></TR></TBODY></TABLE><!-- don't edit end --></BODY></HTML>
